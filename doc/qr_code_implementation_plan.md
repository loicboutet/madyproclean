# QR Code Scanning Implementation Plan

**Feature:** Field Agent Clock-In/Out via QR Code Scanning  
**Target Users:** 100-140 Field Agents  
**Platform:** Responsive Web Application (Mobile-First)  
**Date Created:** November 14, 2025

---

## üìã Overview

This document outlines the implementation plan for the QR code-based time tracking system where field agents can clock in and out by scanning QR codes posted at work sites using their smartphones.

### Key Requirements
- ‚úÖ Web-based solution (NO native mobile app)
- ‚úÖ QR codes generated by admins for each site
- ‚úÖ Agents scan QR codes with smartphone camera
- ‚úÖ Ultra-minimal agent interface (no company info, no schedules, no time data)
- ‚úÖ Records time entries with anti-fraud tracking
- ‚úÖ Separate domain for agent access
- ‚úÖ Simple confirmations: "Clock-in validated" / "Clock-out validated"

---

## üéØ Implementation Steps

### PHASE 1: Database & Model Setup

#### 1.1 Verify Site Model has QR Code Support
**File:** `app/models/site.rb`

**Check for existing fields:**
- `qr_code_token` (string, unique) - secure token for QR URL

**Add methods if not present:**
```ruby
class Site < ApplicationRecord
  before_create :generate_qr_code_token
  
  # Generate secure random token for QR code
  def generate_qr_code_token
    self.qr_code_token = SecureRandom.urlsafe_base64(32)
  end
  
  # Full URL for QR code (adjust domain as needed)
  def qr_code_url
    Rails.application.routes.url_helpers.scan_qr_url(token: qr_code_token, host: ENV['AGENT_DOMAIN'] || 'localhost:3000')
  end
  
  # Generate QR code image using rqrcode gem
  def qr_code_image(size: 300)
    require 'rqrcode'
    qrcode = RQRCode::QRCode.new(qr_code_url)
    qrcode.as_png(
      resize_gte_to: false,
      resize_exactly_to: false,
      fill: 'white',
      color: 'black',
      size: size,
      border_modules: 4,
      module_px_size: 6
    )
  end
  
  # Get currently clocked-in agents at this site
  def current_agents
    User.joins(:time_entries)
        .where(time_entries: { site_id: id, clocked_out_at: nil })
        .distinct
  end
end
```

#### 1.2 Verify TimeEntry Model
**File:** `app/models/time_entry.rb`

**Ensure fields exist:**
- `user_id`
- `site_id`
- `clocked_in_at`
- `clocked_out_at`
- `ip_address_in`
- `ip_address_out`
- `user_agent_in`
- `user_agent_out`
- `status` (enum: active, completed, anomaly)

**Add methods if needed:**
```ruby
class TimeEntry < ApplicationRecord
  belongs_to :user
  belongs_to :site
  
  enum status: { active: 'active', completed: 'completed', anomaly: 'anomaly' }
  
  # Validation: prevent multiple active entries for same user
  validate :no_multiple_active_entries, on: :create
  
  scope :active, -> { where(status: 'active') }
  scope :for_user, ->(user) { where(user_id: user.id) }
  
  # Clock out method
  def clock_out!(ip_address: nil, user_agent: nil)
    update!(
      clocked_out_at: Time.current,
      ip_address_out: ip_address,
      user_agent_out: user_agent,
      status: 'completed',
      duration_minutes: calculate_duration
    )
  end
  
  private
  
  def calculate_duration
    return nil unless clocked_out_at && clocked_in_at
    ((clocked_out_at - clocked_in_at) / 60).round
  end
  
  def no_multiple_active_entries
    if user && user.time_entries.active.exists?
      errors.add(:base, "You are already clocked in at another site")
    end
  end
end
```

#### 1.3 Database Migration (if needed)
**File:** `db/migrate/[timestamp]_add_qr_code_and_anti_fraud_fields.rb`

```ruby
class AddQrCodeAndAntiFraudFields < ActiveRecord::Migration[7.0]
  def change
    # Add to sites table if not exists
    unless column_exists?(:sites, :qr_code_token)
      add_column :sites, :qr_code_token, :string
      add_index :sites, :qr_code_token, unique: true
    end
    
    # Add to time_entries table if not exists
    unless column_exists?(:time_entries, :ip_address_in)
      add_column :time_entries, :ip_address_in, :string
      add_column :time_entries, :ip_address_out, :string
      add_column :time_entries, :user_agent_in, :string
      add_column :time_entries, :user_agent_out, :string
    end
  end
end
```

**Run migration:**
```bash
rails db:migrate
```

---

### PHASE 2: Routes Configuration

#### 2.1 Add Agent Clock Routes
**File:** `config/routes.rb`

```ruby
Rails.application.routes.draw do
  # ... existing routes ...
  
  # Agent Clock-In/Out Routes (minimal, no authentication wall initially)
  # These should be accessible on separate domain in production
  scope module: 'agent', as: 'agent' do
    get '/scan/:token', to: 'clock#scan', as: :scan_qr
    post '/clock/:token/in', to: 'clock#clock_in', as: :clock_in
    post '/clock/:token/out', to: 'clock#clock_out', as: :clock_out
  end
  
  # Admin routes for QR code management
  namespace :admin do
    resources :sites do
      member do
        get :qr_code      # Show QR code
        get :print_qr     # Printable version
      end
    end
  end
end
```

---

### PHASE 3: Agent Clock Controller

#### 3.1 Create Agent Clock Controller
**File:** `app/controllers/agent/clock_controller.rb`

```ruby
class Agent::ClockController < ApplicationController
  skip_before_action :authenticate_user!, only: [:scan]
  before_action :find_site_by_token
  before_action :ensure_authenticated_for_action, only: [:clock_in, :clock_out]
  
  layout 'agent'  # Use minimal agent layout
  
  # GET /scan/:token
  # Agent lands here after scanning QR code
  def scan
    if user_signed_in?
      @active_entry = current_user.time_entries.active.first
      @can_clock_in = @active_entry.nil?
      @can_clock_out = @active_entry.present? && @active_entry.site_id == @site.id
    else
      # Show login prompt or auto-login if using employee_number system
      render :authenticate
    end
  end
  
  # POST /clock/:token/in
  # Clock in at this site
  def clock_in
    # Check if already clocked in
    if current_user.time_entries.active.exists?
      @error = "Vous √™tes d√©j√† point√© sur un autre site"
      render :error and return
    end
    
    # Create time entry
    @time_entry = current_user.time_entries.create!(
      site: @site,
      clocked_in_at: Time.current,
      ip_address_in: request.remote_ip,
      user_agent_in: request.user_agent,
      status: 'active'
    )
    
    @message = "‚úÖ Pointage d'entr√©e valid√©"
    render :success
  rescue ActiveRecord::RecordInvalid => e
    @error = "Erreur: #{e.message}"
    render :error
  end
  
  # POST /clock/:token/out
  # Clock out from this site
  def clock_out
    # Find active entry for this user at this site
    @time_entry = current_user.time_entries.active.find_by(site: @site)
    
    if @time_entry.nil?
      @error = "Aucun pointage actif trouv√© pour ce site"
      render :error and return
    end
    
    # Clock out
    @time_entry.clock_out!(
      ip_address: request.remote_ip,
      user_agent: request.user_agent
    )
    
    @message = "‚úÖ Pointage de sortie valid√©"
    render :success
  rescue => e
    @error = "Erreur: #{e.message}"
    render :error
  end
  
  private
  
  def find_site_by_token
    @site = Site.active.find_by!(qr_code_token: params[:token])
  rescue ActiveRecord::RecordNotFound
    render plain: "QR Code invalide", status: :not_found
  end
  
  def ensure_authenticated_for_action
    unless user_signed_in?
      redirect_to agent_scan_qr_path(token: params[:token]), alert: "Veuillez vous authentifier"
    end
  end
end
```

---

### PHASE 4: Agent Views (Ultra-Minimal)

#### 4.1 Create Agent Layout
**File:** `app/views/layouts/agent.html.erb`

```erb
<!DOCTYPE html>
<html>
<head>
  <title>Pointage</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <style>
    /* Ultra-minimal mobile-first styling */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: white;
      padding: 40px 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    .btn {
      width: 100%;
      padding: 18px;
      font-size: 1.25rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px 0;
      transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .message {
      font-size: 1.5rem;
      margin: 20px 0;
      padding: 20px;
      border-radius: 8px;
    }
    .success { background: #d1fae5; color: #065f46; }
    .error { background: #fee2e2; color: #991b1b; }
    .icon { font-size: 3rem; margin-bottom: 20px; }
  </style>
</head>
<body>
  <%= yield %>
</body>
</html>
```

#### 4.2 Scan Page (Decision Point)
**File:** `app/views/agent/clock/scan.html.erb`

```erb
<div class="container">
  <% if @can_clock_in %>
    <div class="icon">üì•</div>
    <%= form_with url: agent_clock_in_path(token: params[:token]), method: :post, local: true do |f| %>
      <%= f.submit "Pointer l'entr√©e", class: "btn btn-primary" %>
    <% end %>
  <% elsif @can_clock_out %>
    <div class="icon">üì§</div>
    <%= form_with url: agent_clock_out_path(token: params[:token]), method: :post, local: true do |f| %>
      <%= f.submit "Pointer la sortie", class: "btn btn-success" %>
    <% end %>
  <% else %>
    <div class="icon">‚ö†Ô∏è</div>
    <p style="margin: 20px 0;">Vous √™tes point√© sur un autre site.</p>
  <% end %>
</div>
```

#### 4.3 Success Page
**File:** `app/views/agent/clock/success.html.erb`

```erb
<div class="container">
  <div class="icon">‚úÖ</div>
  <div class="message success">
    <%= @message %>
  </div>
</div>
```

#### 4.4 Error Page
**File:** `app/views/agent/clock/error.html.erb`

```erb
<div class="container">
  <div class="icon">‚ùå</div>
  <div class="message error">
    <%= @error %>
  </div>
  <%= link_to "Retour", agent_scan_qr_path(token: params[:token]), class: "btn btn-primary", style: "margin-top: 20px; text-decoration: none; display: block;" %>
</div>
```

#### 4.5 Authentication Page (if needed)
**File:** `app/views/agent/clock/authenticate.html.erb`

```erb
<div class="container">
  <div class="icon">üîê</div>
  <h2 style="margin-bottom: 20px;">Authentification requise</h2>
  
  <%= form_with url: user_session_path, local: true do |f| %>
    <div style="margin: 15px 0; text-align: left;">
      <%= f.label :email, "Email ou Matricule", style: "display: block; margin-bottom: 5px;" %>
      <%= f.text_field :email, style: "width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;" %>
    </div>
    
    <div style="margin: 15px 0; text-align: left;">
      <%= f.label :password, "Code", style: "display: block; margin-bottom: 5px;" %>
      <%= f.password_field :password, style: "width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;" %>
    </div>
    
    <%= f.submit "Se connecter", class: "btn btn-primary" %>
  <% end %>
</div>
```

---

### PHASE 5: Admin QR Code Management

#### 5.1 Update Sites Controller
**File:** `app/controllers/admin/sites_controller.rb`

Add methods:
```ruby
class Admin::SitesController < ApplicationController
  # ... existing actions ...
  
  # GET /admin/sites/:id/qr_code
  def qr_code
    @site = Site.find(params[:id])
  end
  
  # GET /admin/sites/:id/print_qr
  def print_qr
    @site = Site.find(params[:id])
    render layout: 'print'
  end
end
```

#### 5.2 QR Code Display View
**File:** `app/views/admin/sites/qr_code.html.erb`

```erb
<div class="page-header">
  <h1>QR Code - <%= @site.name %></h1>
  <%= link_to "‚Üê Retour", admin_sites_path, class: "btn btn-secondary" %>
</div>

<div class="card" style="max-width: 600px; margin: 0 auto; text-align: center;">
  <div class="card-body">
    <h2 style="margin-bottom: 30px;"><%= @site.name %></h2>
    
    <!-- QR Code Image -->
    <div style="margin: 30px 0;">
      <%= image_tag "data:image/png;base64,#{Base64.strict_encode64(@site.qr_code_image.to_s)}", 
                    alt: "QR Code #{@site.name}",
                    style: "max-width: 400px; width: 100%;" %>
    </div>
    
    <p style="margin: 20px 0; color: #666;">
      <strong>URL:</strong><br>
      <code style="background: #f5f5f5; padding: 10px; border-radius: 4px; display: inline-block; margin-top: 5px;">
        <%= @site.qr_code_url %>
      </code>
    </p>
    
    <div style="margin-top: 30px;">
      <%= link_to "üñ®Ô∏è Version imprimable", print_qr_admin_site_path(@site), 
                  class: "btn btn-primary", 
                  target: "_blank" %>
      <%= link_to "üìÑ T√©l√©charger PNG", "#", 
                  class: "btn btn-secondary",
                  id: "download-qr" %>
    </div>
  </div>
</div>

<script>
  document.getElementById('download-qr').addEventListener('click', function(e) {
    e.preventDefault();
    const img = document.querySelector('img[alt*="QR Code"]');
    const link = document.createElement('a');
    link.download = 'qr-code-<%= @site.code %>.png';
    link.href = img.src;
    link.click();
  });
</script>
```

#### 5.3 Printable QR Code View
**File:** `app/views/admin/sites/print_qr.html.erb`

```erb
<!DOCTYPE html>
<html>
<head>
  <title>QR Code - <%= @site.name %></title>
  <style>
    @page { size: A4; margin: 2cm; }
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
    }
    .site-name {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 40px;
    }
    .qr-code {
      margin: 40px auto;
    }
    .instructions {
      margin-top: 40px;
      font-size: 1.2rem;
      color: #333;
    }
    @media print {
      .no-print { display: none; }
    }
  </style>
</head>
<body>
  <div class="site-name"><%= @site.name %></div>
  
  <div class="qr-code">
    <%= image_tag "data:image/png;base64,#{Base64.strict_encode64(@site.qr_code_image(size: 400).to_s)}", 
                  alt: "QR Code",
                  style: "width: 400px; height: 400px;" %>
  </div>
  
  <div class="instructions">
    <p><strong>Instructions:</strong></p>
    <p>Scannez ce QR code avec votre smartphone pour pointer</p>
  </div>
  
  <div class="no-print" style="margin-top: 40px;">
    <button onclick="window.print()" style="padding: 15px 30px; font-size: 1.1rem; cursor: pointer;">
      üñ®Ô∏è Imprimer
    </button>
  </div>
</body>
</html>
```

#### 5.4 Add QR Code Link to Sites Index
**File:** `app/views/admin/sites/index.html.erb`

Add in the actions column:
```erb
<%= link_to "üì± QR Code", qr_code_admin_site_path(site), class: "btn btn-sm btn-info" %>
```

---

### PHASE 6: Dependencies & Configuration

#### 6.1 Add RQRCode Gem
**File:** `Gemfile`

```ruby
# QR Code generation
gem 'rqrcode', '~> 2.0'
```

Install:
```bash
bundle install
```

#### 6.2 Environment Configuration
**File:** `.env` or `config/environments/production.rb`

```bash
# Agent clock-in domain (separate from admin)
AGENT_DOMAIN=clock.company.com

# Main admin/manager domain
ADMIN_DOMAIN=admin.company.com
```

#### 6.3 Generate QR Tokens for Existing Sites
**File:** `lib/tasks/generate_qr_tokens.rake`

```ruby
namespace :sites do
  desc "Generate QR code tokens for sites missing them"
  task generate_qr_tokens: :environment do
    sites_updated = 0
    
    Site.where(qr_code_token: nil).find_each do |site|
      site.update!(qr_code_token: SecureRandom.urlsafe_base64(32))
      sites_updated += 1
      puts "‚úÖ Generated QR token for: #{site.name}"
    end
    
    puts "\nüéâ Updated #{sites_updated} site(s)"
  end
end
```

Run:
```bash
rails sites:generate_qr_tokens
```

---

### PHASE 7: Testing & Validation

#### 7.1 Manual Testing Checklist

**Admin Side:**
- [ ] Can view QR code for a site
- [ ] QR code image displays correctly
- [ ] Can access printable version
- [ ] Can download QR code as PNG

**Agent Side:**
- [ ] Scan QR code with phone camera
- [ ] URL opens in mobile browser
- [ ] Interface is ultra-minimal (no extra info)
- [ ] Can authenticate if needed
- [ ] Clock-in button works
- [ ] Success message displays: "‚úÖ Pointage d'entr√©e valid√©"
- [ ] Can scan again to clock out
- [ ] Clock-out button works
- [ ] Success message displays: "‚úÖ Pointage de sortie valid√©"
- [ ] Cannot clock in twice
- [ ] Anti-fraud data captured (IP, user agent)

**Database Verification:**
- [ ] TimeEntry created with correct timestamps
- [ ] ip_address_in captured
- [ ] user_agent_in captured
- [ ] ip_address_out captured on clock-out
- [ ] duration_minutes calculated
- [ ] status updated from 'active' to 'completed'

#### 7.2 Security Testing
- [ ] Verify QR tokens are unique
- [ ] Verify tokens are sufficiently random (32 chars)
- [ ] Verify no sensitive info in agent URLs
- [ ] Test invalid QR token returns 404
- [ ] Verify CSRF protection on forms
- [ ] Test IP tracking works correctly

---

### PHASE 8: Production Deployment

#### 8.1 Domain Configuration
Set up two domains:
- **Agent domain:** `clock.company.com` ‚Üí Agent QR scanning interface
- **Admin domain:** `admin.company.com` ‚Üí Admin/Manager interface

Configure in Rails:
```ruby
# config/environments/production.rb
config.hosts << "clock.company.com"
config.hosts << "admin.company.com"
```

#### 8.2 SSL Certificates
Ensure both domains have valid SSL certificates:
```bash
certbot --nginx -d clock.company.com -d admin.company.com
```

#### 8.3 Deployment Steps
1. Run migrations: `rails db:migrate`
2. Generate QR tokens: `rails sites:generate_qr_tokens`
3. Deploy application
4. Test QR scanning on production domain
5. Print and distribute QR codes to work sites

---

## üìä Success Metrics

After implementation, verify:
- ‚úÖ All 100-140 agents can successfully scan QR codes
- ‚úÖ Clock-in/out process takes < 10 seconds
- ‚úÖ Mobile interface works on iOS and Android
- ‚úÖ No company information visible to agents
- ‚úÖ Anti-fraud tracking captures IP and user agent
- ‚úÖ Admins can generate and print QR codes
- ‚úÖ Time entries record correctly in database
- ‚úÖ No duplicate active entries possible

---

## üîß Troubleshooting Guide

### Common Issues

**QR Code doesn't scan:**
- Ensure QR code size is adequate (minimum 300x300px)
- Check image quality/contrast
- Verify URL is accessible

**Agent can't clock in:**
- Check authentication status
- Verify site is active
- Check for existing active entry
- Review error logs

**Wrong domain:**
- Ensure AGENT_DOMAIN env variable is set
- Verify DNS configuration
- Check Rails hosts configuration

**Anti-fraud not working:**
- Verify `request.remote_ip` works (check proxy configuration)
- Ensure database columns exist
- Check controller captures data

---

## üìù Future Enhancements (Post-MVP)

- [ ] SMS/Email notifications on clock events
- [ ] Offline mode with sync when online
- [ ] QR code expiration/rotation for security
- [ ] Geolocation verification (optional)
- [ ] Agent photo capture on clock-in
- [ ] Batch QR code printing
- [ ] QR code analytics (scan frequency)

---

## ‚úÖ Completion Checklist

- [ ] Phase 1: Database & Models
- [ ] Phase 2: Routes
- [ ] Phase 3: Controllers
- [ ] Phase 4: Agent Views
- [ ] Phase 5: Admin QR Management
- [ ] Phase 6: Dependencies
- [ ] Phase 7: Testing
- [ ] Phase 8: Deployment

---

**Document Version:** 1.0  
**Last Updated:** November 14, 2025  
**Status:** Ready for Implementation
