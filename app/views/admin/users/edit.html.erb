<% content_for :page_title, "Modifier l'Utilisateur ##{@user[:id]}" %>

<!-- Page Header -->
<div class="glass-card">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="gradient-heading">Modifier l'Utilisateur #<%= @user[:id] %></h1>
      <p class="text-large mt-2">Mettez à jour les informations de l'utilisateur</p>
    </div>
    <div class="button-group">
      <%= link_to admin_user_path(@user[:id]), class: "btn-secondary" do %>
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        Retour aux détails
      <% end %>
    </div>
  </div>
</div>

<div class="divider"></div>

<!-- Form -->
<div class="card">
  <div class="alert alert-warning mb-6">
    <strong>Attention:</strong> La modification du rôle d'un utilisateur peut affecter ses permissions d'accès au système.
  </div>

  <%= form_with url: admin_user_path(@user[:id]), method: :patch, local: true do |form| %>
    
    <!-- Personal Information -->
    <h2 class="mb-4">
      <svg class="inline-block w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
      </svg>
      Informations Personnelles
    </h2>

    <div class="form-grid">
      <div class="form-group">
        <label for="user_first_name">Prénom <span class="text-danger">*</span></label>
        <input 
          type="text" 
          name="user[first_name]" 
          id="user_first_name" 
          value="<%= @user[:first_name] %>"
          placeholder="Ex: Marie"
          required>
        <small class="text-sm opacity-70">Prénom de l'utilisateur</small>
      </div>

      <div class="form-group">
        <label for="user_last_name">Nom <span class="text-danger">*</span></label>
        <input 
          type="text" 
          name="user[last_name]" 
          id="user_last_name" 
          value="<%= @user[:last_name] %>"
          placeholder="Ex: Dubois"
          required>
        <small class="text-sm opacity-70">Nom de famille de l'utilisateur</small>
      </div>
    </div>

    <!-- Contact Information -->
    <div class="divider"></div>
    <h2 class="mb-4">
      <svg class="inline-block w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
      </svg>
      Coordonnées
    </h2>

    <div class="form-grid">
      <div class="form-group">
        <label for="user_email">Email <span class="text-danger">*</span></label>
        <input 
          type="email" 
          name="user[email]" 
          id="user_email" 
          value="<%= @user[:email] %>"
          placeholder="utilisateur@madyproclean.fr"
          required>
        <small class="text-sm opacity-70">Adresse email professionnelle</small>
      </div>

      <div class="form-group">
        <label for="user_phone_number">Téléphone</label>
        <input 
          type="tel" 
          name="user[phone_number]" 
          id="user_phone_number" 
          value="<%= @user[:phone_number] %>"
          placeholder="+33 6 12 34 56 78">
        <small class="text-sm opacity-70">Numéro de téléphone (optionnel)</small>
      </div>
    </div>

    <!-- Employment Details -->
    <div class="divider"></div>
    <h2 class="mb-4">
      <svg class="inline-block w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
      </svg>
      Informations Professionnelles
    </h2>

    <div class="form-grid">
      <div class="form-group">
        <label for="user_employee_number">Matricule</label>
        <input 
          type="text" 
          name="user[employee_number]" 
          id="user_employee_number" 
          value="<%= @user[:employee_number] %>"
          placeholder="Ex: AGT-001"
          style="text-transform: uppercase;">
        <small class="text-sm opacity-70">Numéro d'identification unique (optionnel)</small>
      </div>

      <div class="form-group">
        <label for="user_role">Rôle <span class="text-danger">*</span></label>
        <select name="user[role]" id="user_role" required>
          <option value="">Sélectionnez un rôle...</option>
          <option value="admin" <%= 'selected' if @user[:role] == 'admin' %>>Administrateur</option>
          <option value="manager" <%= 'selected' if @user[:role] == 'manager' %>>Manager / Superviseur</option>
          <option value="agent" <%= 'selected' if @user[:role] == 'agent' %>>Agent Terrain</option>
        </select>
        <small class="text-sm opacity-70">Niveau d'accès de l'utilisateur</small>
      </div>
    </div>

    <!-- Manager Assignment (for agents) -->
    <div id="manager-assignment" style="<%= @user[:role] == 'agent' ? 'display: block;' : 'display: none;' %>">
      <div class="form-group">
        <label for="user_manager_id">Manager assigné</label>
        <select name="user[manager_id]" id="user_manager_id">
          <option value="">Aucun manager</option>
          <% @managers.each do |manager| %>
            <option value="<%= manager[:id] %>" <%= 'selected' if @user[:manager_id] == manager[:id] %>>
              <%= manager[:first_name] %> <%= manager[:last_name] %> (<%= manager[:employee_number] %>)
            </option>
          <% end %>
        </select>
        <small class="text-sm opacity-70">Superviseur responsable de cet agent</small>
      </div>
    </div>

    <!-- Role Information Alert -->
    <div id="role-info-admin" class="alert alert-info mt-4" style="<%= @user[:role] == 'admin' ? 'display: block;' : 'display: none;' %>">
      <strong>Rôle Administrateur:</strong> Accès complet au système, gestion de tous les utilisateurs, sites et données.
    </div>
    <div id="role-info-manager" class="alert alert-warning mt-4" style="<%= @user[:role] == 'manager' ? 'display: block;' : 'display: none;' %>">
      <strong>Rôle Manager:</strong> Gestion d'équipe, planification des horaires, déclaration des absences.
    </div>
    <div id="role-info-agent" class="alert alert-success mt-4" style="<%= @user[:role] == 'agent' ? 'display: block;' : 'display: none;' %>">
      <strong>Rôle Agent:</strong> Accès limité au pointage via QR code sur les sites assignés.
    </div>

    <!-- Status -->
    <div class="divider"></div>
    <h2 class="mb-4">
      <svg class="inline-block w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Statut
    </h2>

    <div class="form-group">
      <label class="flex items-center">
        <input 
          type="checkbox" 
          name="user[active]" 
          id="user_active" 
          value="1"
          <%= 'checked' if @user[:active] %>
          style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem;">
        <span class="font-semibold">Utilisateur actif</span>
      </label>
      <small class="text-sm opacity-70">Les utilisateurs inactifs ne peuvent pas se connecter au système</small>
    </div>

    <% unless @user[:active] %>
      <div class="alert alert-warning mt-4">
        <strong>⚠️ Utilisateur actuellement inactif</strong><br>
        Cet utilisateur ne peut pas se connecter au système. Cochez la case ci-dessus pour le réactiver.
      </div>
    <% end %>

    <!-- Timestamp Information -->
    <div class="divider"></div>
    <div class="form-grid">
      <div>
        <p class="text-sm opacity-70">Créé le</p>
        <% if @user[:created_at] %>
          <p class="font-semibold"><%= @user[:created_at].strftime('%d/%m/%Y à %H:%M') %></p>
        <% else %>
          <p class="font-semibold">N/A</p>
        <% end %>
      </div>
      
      <div>
        <p class="text-sm opacity-70">Dernière modification</p>
        <% if @user[:updated_at] %>
          <p class="font-semibold"><%= @user[:updated_at].strftime('%d/%m/%Y à %H:%M') %></p>
        <% else %>
          <p class="font-semibold">N/A</p>
        <% end %>
      </div>
    </div>

    <!-- Actions -->
    <div class="divider"></div>
    <div class="button-group">
      <button type="submit" class="btn-primary">
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Enregistrer les modifications
      </button>
      
      <%= link_to admin_user_path(@user[:id]), class: "btn-secondary" do %>
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        Annuler
      <% end %>

      <%= link_to admin_users_path, class: "btn-secondary" do %>
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
        </svg>
        Retour à la liste
      <% end %>
    </div>
  <% end %>
</div>

<!-- Danger Zone -->
<div class="divider"></div>

<div class="card" style="border: 2px solid #ef4444;">
  <h2 class="mb-4" style="color: #ef4444;">
    <svg class="inline-block w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
    </svg>
    Zone de Danger
  </h2>
  
  <div class="alert alert-warning mb-4">
    <strong>Attention:</strong> Ces actions sont irréversibles ou peuvent avoir un impact important sur le système.
  </div>

  <div class="button-group">
    <% if @user[:active] %>
      <%= button_to admin_user_path(@user[:id]), method: :delete, data: { confirm: 'Êtes-vous sûr de vouloir désactiver cet utilisateur ? Il ne pourra plus se connecter au système.' }, class: "btn-danger" do %>
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
        </svg>
        Désactiver cet utilisateur
      <% end %>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.getElementById('user_role');
    const managerAssignment = document.getElementById('manager-assignment');
    const employeeNumberInput = document.getElementById('user_employee_number');
    
    const roleInfoAdmin = document.getElementById('role-info-admin');
    const roleInfoManager = document.getElementById('role-info-manager');
    const roleInfoAgent = document.getElementById('role-info-agent');

    function updateRoleVisibility() {
      const role = roleSelect.value;
      
      // Show/hide manager assignment for agents
      if (role === 'agent') {
        managerAssignment.style.display = 'block';
      } else {
        managerAssignment.style.display = 'none';
      }

      // Show appropriate role info
      roleInfoAdmin.style.display = role === 'admin' ? 'block' : 'none';
      roleInfoManager.style.display = role === 'manager' ? 'block' : 'none';
      roleInfoAgent.style.display = role === 'agent' ? 'block' : 'none';
    }

    // Initialize on page load
    updateRoleVisibility();

    // Update when role changes
    roleSelect.addEventListener('change', updateRoleVisibility);

    // Force uppercase for employee number
    if (employeeNumberInput) {
      employeeNumberInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
    }
  });
</script>
