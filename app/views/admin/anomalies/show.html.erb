<% content_for :page_title, "D√©tails de l'Anomalie ##{@anomaly[:id]}" %>

<!-- Page Header -->
<div class="glass-card">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="gradient-heading">D√©tails de l'Anomalie #<%= @anomaly[:id] %></h1>
      <p class="text-large mt-2">Informations compl√®tes de cette anomalie d√©tect√©e</p>
    </div>
    <div class="button-group">
      <%= link_to admin_anomalies_path, class: "btn-secondary" do %>
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        Retour √† la liste
      <% end %>
    </div>
  </div>
</div>

<div class="divider"></div>

<!-- Status Card -->
<div class="card">
  <div class="flex items-center justify-between mb-6">
    <h2 style="font-size: 1.875rem;">Statut de l'Anomalie</h2>
    <% if @anomaly[:resolved] %>
      <span class="badge-success" style="font-size: 1.125rem; padding: 0.75rem 1.5rem;">‚úì R√©solue</span>
    <% else %>
      <span class="badge-warning" style="font-size: 1.125rem; padding: 0.75rem 1.5rem;">‚ö† Non R√©solue</span>
    <% end %>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon stat-icon-primary">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
      </div>
      <div class="stat-content">
        <p class="stat-label">Type d'Anomalie</p>
        <% case @anomaly[:anomaly_type] %>
        <% when 'missed_clock_in' %>
          <p class="stat-value" style="font-size: 1.25rem;">üì• Entr√©e Manquante</p>
        <% when 'missed_clock_out' %>
          <p class="stat-value" style="font-size: 1.25rem;">üì§ Sortie Manquante</p>
        <% when 'over_24h' %>
          <p class="stat-value" style="font-size: 1.25rem;">‚è±Ô∏è Plus de 24h</p>
        <% when 'multiple_active' %>
          <p class="stat-value" style="font-size: 1.25rem;">üîÑ Pointages Multiples</p>
        <% when 'schedule_mismatch' %>
          <p class="stat-value" style="font-size: 1.25rem;">üìÖ D√©saccord Horaire</p>
        <% end %>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon <%= @anomaly[:severity] == 'high' ? 'stat-icon-danger' : (@anomaly[:severity] == 'medium' ? 'stat-icon-warning' : 'stat-icon-info') %>">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <div class="stat-content">
        <p class="stat-label">Niveau de S√©v√©rit√©</p>
        <% if @anomaly[:severity] == 'low' %>
          <p class="stat-value" style="font-size: 1.25rem;">üîµ Faible</p>
        <% elsif @anomaly[:severity] == 'medium' %>
          <p class="stat-value" style="font-size: 1.25rem;">üü° Moyenne</p>
        <% elsif @anomaly[:severity] == 'high' %>
          <p class="stat-value" style="font-size: 1.25rem;">üî¥ Haute</p>
        <% end %>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-icon-success">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
      </div>
      <div class="stat-content">
        <p class="stat-label">Agent Concern√©</p>
        <p class="stat-value" style="font-size: 1.25rem;"><%= @anomaly[:user_name] %></p>
        <p class="text-sm opacity-70 mt-1"><%= @anomaly[:employee_number] %></p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-icon-info">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
      </div>
      <div class="stat-content">
        <p class="stat-label">Date de D√©tection</p>
        <p class="stat-value" style="font-size: 1.25rem;"><%= @anomaly[:created_at].strftime('%d/%m/%Y') %></p>
        <p class="text-sm opacity-70 mt-1"><%= @anomaly[:created_at].strftime('%H:%M') %></p>
      </div>
    </div>
  </div>
</div>

<div class="divider"></div>

<!-- Anomaly Details -->
<div class="card">
  <h2 class="mb-6" style="font-size: 1.875rem;">
    <svg class="inline-block w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    Informations D√©taill√©es
  </h2>

  <div class="form-grid">
    <div class="form-group">
      <label>ID de l'Anomalie</label>
      <div class="">
        <p class="font-semibold text-lg">#<%= @anomaly[:id] %></p>
      </div>
    </div>

    <div class="form-group">
      <label>Type d'Anomalie</label>
      <div class="">
        <% case @anomaly[:anomaly_type] %>
        <% when 'missed_clock_in' %>
          <span class="badge-warning">üì• Pointage d'entr√©e manquant</span>
        <% when 'missed_clock_out' %>
          <span class="badge-warning">üì§ Pointage de sortie manquant</span>
        <% when 'over_24h' %>
          <span class="badge-danger">‚è±Ô∏è Actif plus de 24 heures</span>
        <% when 'multiple_active' %>
          <span class="badge-danger">üîÑ Pointages multiples simultan√©s</span>
        <% when 'schedule_mismatch' %>
          <span class="badge-info">üìÖ D√©saccord avec l'horaire planifi√©</span>
        <% end %>
      </div>
    </div>

    <div class="form-group">
      <label>Niveau de S√©v√©rit√©</label>
      <div class="">
        <% if @anomaly[:severity] == 'low' %>
          <span class="badge-info">üîµ Faible</span>
        <% elsif @anomaly[:severity] == 'medium' %>
          <span class="badge-warning">üü° Moyenne</span>
        <% elsif @anomaly[:severity] == 'high' %>
          <span class="badge-danger">üî¥ Haute</span>
        <% end %>
      </div>
    </div>

    <div class="form-group">
      <label>Statut de R√©solution</label>
      <div class="">
        <% if @anomaly[:resolved] %>
          <span class="badge-success">‚úì R√©solue</span>
        <% else %>
          <span class="badge-warning">‚ö† Non r√©solue</span>
        <% end %>
      </div>
    </div>

    <div class="form-group">
      <label>Agent Concern√©</label>
      <div class="">
        <p class="font-semibold"><%= @anomaly[:user_name] %></p>
        <p class="text-sm opacity-70"><%= @anomaly[:employee_number] %></p>
      </div>
    </div>

    <% if @anomaly[:site_name] %>
    <div class="form-group">
      <label>Site</label>
      <div class="">
        <p class="font-semibold"><%= @anomaly[:site_name] %></p>
        <p class="text-sm opacity-70"><span class="badge"><%= @anomaly[:site_code] %></span></p>
      </div>
    </div>
    <% end %>

    <% if @anomaly[:time_entry_id] %>
    <div class="form-group">
      <label>Pointage Li√©</label>
      <div class="">
        <p class="font-semibold">ID #<%= @anomaly[:time_entry_id] %></p>
      </div>
    </div>
    <% end %>

    <% if @anomaly[:schedule_id] %>
    <div class="form-group">
      <label>Horaire Planifi√© Li√©</label>
      <div class="">
        <p class="font-semibold">ID #<%= @anomaly[:schedule_id] %></p>
      </div>
    </div>
    <% end %>

    <div class="form-group">
      <label>Date de D√©tection</label>
      <div class="">
        <p class="font-semibold"><%= @anomaly[:created_at].strftime('%d/%m/%Y √† %H:%M') %></p>
      </div>
    </div>

    <div class="form-group">
      <label>Derni√®re Modification</label>
      <div class="">
        <p class="font-semibold"><%= @anomaly[:updated_at].strftime('%d/%m/%Y √† %H:%M') %></p>
      </div>
    </div>
  </div>

  <div class="divider"></div>
  
  <div class="form-group">
    <label>Description de l'Anomalie</label>
    <div class="p-4 rounded-lg border border-orange-200 bg-orange-50">
      <p class="text-base"><%= @anomaly[:description] %></p>
    </div>
  </div>
</div>

<% if @anomaly[:resolved] %>
  <div class="divider"></div>

  <!-- Resolution Information -->
  <div class="card" style="border-left: 4px solid #10b981;">
    <h2 class="mb-6" style="font-size: 1.875rem;">
      <svg class="inline-block w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Informations de R√©solution
    </h2>

    <div class="alert alert-success mb-6">
      <strong>‚úì Anomalie R√©solue:</strong> Cette anomalie a √©t√© trait√©e et marqu√©e comme r√©solue
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label>R√©solue Par</label>
        <div class="">
          <p class="font-semibold text-green-700"><%= @anomaly[:resolved_by_name] %></p>
        </div>
      </div>

      <div class="form-group">
        <label>Date de R√©solution</label>
        <div class="p-3 bg-green-50 rounded-lg border border-green-200">
          <p class="font-semibold text-green-800"><%= @anomaly[:resolved_at].strftime('%d/%m/%Y √† %H:%M') %></p>
        </div>
      </div>
    </div>

    <% if @anomaly[:resolution_notes].present? %>
      <div class="divider"></div>
      <div class="form-group">
        <label>Notes de R√©solution</label>
        <div class="p-4 bg-green-50 rounded-lg border border-green-200">
          <p class="text-base"><%= @anomaly[:resolution_notes] %></p>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="divider"></div>

  <!-- Action Required -->
  <div class="card" style="border-left: 4px solid #f59e0b;">
    <h2 class="mb-6" style="font-size: 1.875rem;">
      <svg class="inline-block w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
      </svg>
      Action Requise
    </h2>

    <div class="alert alert-warning mb-6">
      <strong>‚ö† Attention:</strong> Cette anomalie n√©cessite votre intervention. Veuillez v√©rifier les d√©tails et prendre les mesures appropri√©es.
    </div>

    <div class="button-group">
      <%= link_to resolve_admin_anomaly_path(@anomaly[:id]), method: :post, class: "btn-primary", data: { confirm: '√ätes-vous s√ªr de vouloir marquer cette anomalie comme r√©solue ?' } do %>
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Marquer comme R√©solue
      <% end %>
    </div>
  </div>
<% end %>

<div class="divider"></div>

<!-- Actions -->
<div class="glass-card">
  <h2 class="mb-4" style="font-size: 1.875rem;">Actions</h2>
  
  <div class="button-group">
    <%= link_to admin_anomalies_path, class: "btn-secondary" do %>
      <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      Retour √† la liste
    <% end %>

    <% if @anomaly[:time_entry_id] %>
      <%= link_to admin_time_entry_path(@anomaly[:time_entry_id]), class: "btn-secondary" do %>
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Voir le Pointage
      <% end %>
    <% end %>

    <% if @anomaly[:schedule_id] %>
      <%= link_to admin_schedule_path(@anomaly[:schedule_id]), class: "btn-secondary" do %>
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        Voir l'Horaire
      <% end %>
    <% end %>

    <% unless @anomaly[:resolved] %>
      <%= link_to resolve_admin_anomaly_path(@anomaly[:id]), method: :post, class: "btn-primary", data: { confirm: '√ätes-vous s√ªr de vouloir marquer cette anomalie comme r√©solue ?' } do %>
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Marquer comme R√©solue
      <% end %>
    <% end %>
  </div>
</div>
