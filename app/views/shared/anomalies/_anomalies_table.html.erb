<!-- Anomalies Table -->
<div class="card">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="mb-2" style="font-size: 1.875rem;">Liste des Anomalies</h2>
      <p class="text-large">Visualisez toutes les anomalies détectées avec leurs détails</p>
    </div>
  </div>

  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Type d'Anomalie</th>
          <th>Sévérité</th>
          <th>Agent</th>
          <th>Description</th>
          <th>Date de Détection</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if anomalies.empty? %>
          <tr>
            <td colspan="8" style="text-align: center; padding: 2rem;">
              <div class="alert alert-success" style="display: inline-block;">
                <strong>Aucune anomalie trouvée</strong> avec les filtres actuels
              </div>
            </td>
          </tr>
        <% else %>
          <% anomalies.each do |anomaly| %>
            <tr>
              <td><strong>#<%= anomaly.id %></strong></td>
              <td>
                <span class="<%= anomaly.anomaly_type_over_24h? || anomaly.anomaly_type_multiple_active? ? 'badge-danger' : anomaly.anomaly_type_schedule_mismatch? ? 'badge-info' : 'badge-warning' %>">
                  <%= anomaly.type_label %>
                </span>
              </td>
              <td>
                <span class="<%= anomaly.severity_low? ? 'badge-info' : anomaly.severity_medium? ? 'badge-warning' : 'badge-danger' %>">
                  <%= anomaly.severity_label %>
                </span>
              </td>
              <td>
                <% if anomaly.user %>
                  <div>
                    <p class="font-semibold"><%= anomaly.user.full_name %></p>
                    <p class="text-sm opacity-70"><%= anomaly.user.employee_number %></p>
                  </div>
                <% else %>
                  <span class="text-sm opacity-70">N/A</span>
                <% end %>
              </td>
              <td>
                <p class="text-sm"><%= anomaly.description %></p>
              </td>
              <td>
                <div>
                  <p class="font-semibold"><%= anomaly.created_at.strftime('%d/%m/%Y') %></p>
                  <p class="text-sm opacity-70"><%= anomaly.created_at.strftime('%H:%M') %></p>
                </div>
              </td>
              <td>
                <% if anomaly.resolved %>
                  <div>
                    <span class="badge-success">✓ Résolue</span>
                    <% if anomaly.resolved_by %>
                      <p class="text-sm opacity-70 mt-1">Par <%= anomaly.resolved_by.full_name %></p>
                      <p class="text-sm opacity-70">Le <%= anomaly.resolved_at.strftime('%d/%m/%Y') %></p>
                    <% end %>
                  </div>
                <% else %>
                  <span class="badge-warning">⚠ Non résolue</span>
                <% end %>
              </td>
              <td>
                <div class="dropdown-wrapper" data-controller="dropdown">
                  <button class="dropdown-trigger" data-action="click->dropdown#toggle" title="Actions">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                    </svg>
                  </button>
                  
                  <div class="dropdown-menu hidden" data-dropdown-target="menu">
                    <%= link_to send("#{namespace}_anomaly_path", anomaly), class: "dropdown-item" do %>
                      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                      </svg>
                      <span>Voir Détails</span>
                    <% end %>
                    <% unless anomaly.resolved %>
                      <div class="dropdown-divider"></div>
                      <%= link_to send("resolve_#{namespace}_anomaly_path", anomaly), method: :post, class: "dropdown-item" do %>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Marquer comme Résolue</span>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <%= paginate anomalies %>
</div>
