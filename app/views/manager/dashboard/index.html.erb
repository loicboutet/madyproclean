<% content_for :title, "Tableau de Bord Manager" %>
<% content_for :head do %>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<% end %>

<!-- Welcome Card -->
<div class="card">
  <h2>Bienvenue au Tableau de Bord Manager</h2>
  <p>Interface de gestion pour les superviseurs - Gérez votre équipe, déclarez les absences et consultez les plannings.</p>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-card-icon">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
      </svg>
    </div>
    <div class="stat-card-content">
      <div class="stat-value"><%= @team_count %></div>
      <div class="stat-label">Membres Équipe</div>
    </div>
  </div>
  
  <div class="stat-card">
    <div class="stat-card-icon">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
    </div>
    <div class="stat-card-content">
      <div class="stat-value"><%= @active_today_count %></div>
      <div class="stat-label">Actifs Aujourd'hui</div>
    </div>
  </div>
  
  <div class="stat-card">
    <div class="stat-card-icon">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
      </svg>
    </div>
    <div class="stat-card-content">
      <div class="stat-value"><%= @absences_count %></div>
      <div class="stat-label">Absences En Cours</div>
    </div>
  </div>
  
  <div class="stat-card">
    <div class="stat-card-icon">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
      </svg>
    </div>
    <div class="stat-card-content">
      <div class="stat-value"><%= @sites_count %></div>
      <div class="stat-label">Sites Couverts</div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="glass-card">
  <h3>Actions Rapides</h3>
  <div class="button-group">
    <%= link_to manager_team_index_path, class: "btn-primary" do %>
      <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
      </svg>
      <span>Voir Mon Équipe</span>
    <% end %>
    
    <%= link_to new_manager_absence_path, class: "btn-secondary" do %>
      <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
      </svg>
      <span>Déclarer une Absence</span>
    <% end %>
    
    <%= link_to manager_schedules_path, class: "btn-secondary" do %>
      <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
      <span>Voir les Plannings</span>
    <% end %>
    
    <%= link_to manager_replacements_path, class: "btn-secondary" do %>
      <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
      </svg>
      <span>Gérer Remplacements</span>
    <% end %>
  </div>
</div>

<!-- Charts Section -->
<div class="charts-grid" style="margin-top: 2rem;" data-controller="manager-charts" data-manager-charts-data-value="<%= @chart_data.to_json %>">
  <!-- Team Activity Chart -->
  <div class="glass-card">
    <h3>Activité de l'Équipe (7 Derniers Jours)</h3>
    <div class="chart-container">
      <canvas id="teamActivityChart"></canvas>
    </div>
  </div>

  <!-- Absences Trend Chart -->
  <div class="glass-card">
    <h3>Tendance des Absences</h3>
    <div class="chart-container">
      <canvas id="absencesTrendChart"></canvas>
    </div>
  </div>
</div>

<!-- Team Activity Grid -->
<div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-top: 2rem;">
  
  <!-- Recent Team Time Entries - Condensed -->
  <div class="glass-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
      <h3 style="margin-bottom: 0;">Pointages Récents</h3>
      <%= link_to manager_time_entries_path, class: "btn-icon-only btn-view" do %>
        <span>Voir Tout</span>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      <% end %>
    </div>
    
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Agent</th>
            <th>Site</th>
            <th>Arrivée</th>
            <th>Départ</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          <% if @recent_time_entries.any? %>
            <% @recent_time_entries.each do |entry| %>
              <tr>
                <td><%= entry.user.full_name %></td>
                <td><%= entry.site.name %></td>
                <td><%= entry.clocked_in_at&.strftime('%d/%m/%Y %H:%M') %></td>
                <td><%= entry.clocked_out_at&.strftime('%d/%m/%Y %H:%M') %></td>
                <td>
                  <% case entry.status %>
                  <% when 'completed' %>
                    <span class="badge-success">Complet</span>
                  <% when 'active' %>
                    <span class="badge">En cours</span>
                  <% when 'anomaly' %>
                    <span class="badge-warning">Anomalie</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="5" style="text-align: center; color: rgba(255, 255, 255, 0.6);">
                Aucun pointage récent pour votre équipe
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Upcoming Absences - Condensed -->
  <div class="glass-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h3 style="margin-bottom: 0;">Absences à Venir</h3>
      <%= link_to manager_absences_path, class: "btn-icon-only btn-view" do %>
        <span>Voir Tout</span>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      <% end %>
    </div>
    
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Agent</th>
            <th>Type</th>
            <th>Date Début</th>
            <th>Date Fin</th>
            <th>Durée</th>
            <th>Raison</th>
          </tr>
        </thead>
        <tbody>
          <% if @upcoming_absences.any? %>
            <% @upcoming_absences.each do |absence| %>
              <tr>
                <td><%= absence.user.full_name %></td>
                <td><span class="<%= absence.type_badge_class %>"><%= absence.type_label %></span></td>
                <td><%= l(absence.start_date, format: :short) %></td>
                <td><%= l(absence.end_date, format: :short) %></td>
                <td><%= absence.duration_days %> <%= absence.duration_days == 1 ? 'jour' : 'jours' %></td>
                <td><%= absence.reason || '-' %></td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="6" style="text-align: center; color: rgba(255, 255, 255, 0.6);">
                Aucune absence à venir pour votre équipe
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Team Schedule Summary -->
  <div class="glass-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h3 style="margin-bottom: 0;">Planning de la Semaine</h3>
      <%= link_to manager_schedules_path, class: "btn-icon-only btn-view" do %>
        <span>Voir Planning Complet</span>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      <% end %>
    </div>
    
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Agent</th>
            <th>Site</th>
            <th>Horaires</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          <% if @upcoming_schedules.any? %>
            <% @upcoming_schedules.each do |schedule| %>
              <tr>
                <td><%= l(schedule.scheduled_date, format: :short) %></td>
                <td><%= schedule.user.full_name %></td>
                <td><%= schedule.site.name %></td>
                <td><%= schedule.start_time.strftime('%H:%M') %> - <%= schedule.end_time.strftime('%H:%M') %></td>
                <td>
                  <% case schedule.status %>
                  <% when 'completed' %>
                    <span class="badge-success">Complété</span>
                  <% when 'scheduled' %>
                    <span class="badge">Planifié</span>
                  <% when 'missed' %>
                    <span class="badge-warning">Manqué</span>
                  <% when 'cancelled' %>
                    <span class="badge-danger">Annulé</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="5" style="text-align: center; color: rgba(255, 255, 255, 0.6);">
                Aucun planning à venir pour votre équipe
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Site Coverage -->
  <div class="glass-card">
    <h3>Couverture des Sites</h3>
    <% if @sites_coverage.any? %>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <% @sites_coverage.each do |site| %>
          <% agent_count = site.agents_count.to_i %>
          <% 
            # Determine styling based on agent count
            if agent_count == 0
              bg_color = "rgba(255, 193, 7, 0.1)"
              border_color = "rgba(255, 193, 7, 0.3)"
              title_color = "#ffc107"
              count_color = "#ffc107"
              status_text = "Besoin remplacement"
            elsif agent_count == 1
              bg_color = "rgba(0, 212, 255, 0.1)"
              border_color = "rgba(0, 212, 255, 0.3)"
              title_color = "#00D4FF"
              count_color = "#00FFE0"
              status_text = "Couverture minimale"
            elsif agent_count >= 3
              bg_color = "rgba(0, 212, 255, 0.1)"
              border_color = "rgba(0, 212, 255, 0.3)"
              title_color = "#00D4FF"
              count_color = "#00FFE0"
              status_text = "Planning complet"
            else
              bg_color = "rgba(0, 212, 255, 0.1)"
              border_color = "rgba(0, 212, 255, 0.3)"
              title_color = "#00D4FF"
              count_color = "#00FFE0"
              status_text = "Couverture normale"
            end
          %>
          <div class="card" style="background: <%= bg_color %>; border: 1px solid <%= border_color %>; padding: 1.5rem;">
            <h4 style="margin-bottom: 0.75rem; color: <%= title_color %>;"><%= site.name %></h4>
            <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
              <span style="font-size: 2rem; font-weight: 700; color: <%= count_color %>;"><%= agent_count %></span>
              <span style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.7);"><%= agent_count == 1 ? 'agent actif' : 'agents actifs' %></span>
            </div>
            <p style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.6); margin: 0;"><%= status_text %></p>
          </div>
        <% end %>
      </div>
    <% else %>
      <p style="text-align: center; color: rgba(255, 255, 255, 0.6); margin-top: 1rem;">
        Aucun site actuellement couvert par votre équipe
      </p>
    <% end %>
  </div>

</div>
